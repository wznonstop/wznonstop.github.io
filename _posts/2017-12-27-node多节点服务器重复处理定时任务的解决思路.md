---
layout: default
title: node多节点服务器重复处理定时任务的解决思路
---


2017-12-27-node多节点服务器重复处理定时任务的解决思路
===================
最近有一个需求，需要使用每天用户留资的信息，导出到excel中，其实就是在每天的特定时间执行定时任务。本地开发完成之后，放到服务器上，发现，怎么回事，每次会生成两份数据？
看了下发现，是启了两个完全相同的服务，心说，这不是很简单，mongoose不是有unique属性吗，加一下。尴尬的是发现没生效，查了一圈，似乎删数据，重启数据库才能生效，应用场景明显不适合，只得另谋他法。想了下，新增数据的时候查一下，没有的话，就新增，已经存在了就不执行呗。
结果事实像冷冷的冰雨砸在了我脸上，这两个服务太同步了以至于，有时候查的时候还没有生成新的数据，导致最终结果有时候生成一条数据，有时候生成两条数据，一时间有点没辙，时间紧急，想了个很low的方案，遍历生成的excel所在的文件夹，获取到文件名，返回到前端，进行展示。

但是这个方案存在的问题实在太多了，首先，生成的excel文件存储在服务器上，会占用服务器内存，在更新代码的时候，还要做备份，不然就丢了。针对这个问题，采取的解决思路是，在定时任务中，只是执行生成查询条件的数据，存入数据库中，
在前端页面点击相应的链接时，使用存入数据库的查询信息进行查询，同步获取数据，直接返回给浏览器，这样既不占内存，又能实现不阻塞的下载，体验更好，还省资源。



![tree](https://raw.githubusercontent.com/wznonstop/wznonstop.github.io/master/images/2016-03-18-1.png)

